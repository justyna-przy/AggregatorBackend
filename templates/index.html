<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Elevator MQTT Feed</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bitcount+Grid+Double+Ink:wght@100..900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="crt-active crt-shift">
    <div class="crt-filter"></div>
    <div class="crt-vignette"></div>
    <header>
      <h1>Elevator MQTT Feed</h1>
    </header>
    <main>
      <h2>Admin Panel</h2>
      <section>
        <div class="console-container">
          <h2>Console</h2>
          <div class="console" id="console"></div>
        </div>

        <audio id="elevator-audio" loop>
          <source src="/static/assets/elavator_music.mp3" type="audio/mpeg" />
        </audio>

        <button id="panic-btn" class="panic-btn">
          <img
            src="/static/assets/emergency-button.jpg"
            alt="Emergency Stop Button"
          />
        </button>
      </section>
    </main>

    <script>
      const consoleEl = document.getElementById("console");
      const audioEl = document.getElementById("elevator-audio");

      function startAudio() {
        if (!audioEl) return;
        audioEl.volume = 0.4;
        audioEl.play().catch(() => {
        });
      }

      function appendLine(msg) {
        const ts = new Date().toLocaleTimeString();
        const line = document.createElement("div");
        line.textContent = `[${ts}] ${msg}`;
        consoleEl.appendChild(line);
        consoleEl.scrollTop = consoleEl.scrollHeight;
      }

      async function loadMessages() {
        try {
          const res = await fetch("/api/messages");
          const data = await res.json();
          consoleEl.textContent = "";
          data.forEach((m) => {
            appendLine(`${m.topic}: ${m.payload}`);
          });
          appendLine(`--- fetched ${data.length} messages ---`);
        } catch (err) {
          console.error(err);
          appendLine(`Error: ${err.message}`);
        }
      }

      document.getElementById("panic-btn").addEventListener("click", () => {
        appendLine("Emergency Stop button pressed -> sending MQTT command");
        startAudio();
        fetch("/api/emergency-stop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ payload: "emergency_stop" }),
        })
          .then((res) => res.json())
          .then((data) => appendLine(`Command status: ${data.status} (${data.topic})`))
          .catch((err) => appendLine(`Command error: ${err.message}`));
      });

      loadMessages();
      setInterval(loadMessages, 1000);

      // Try to start audio on first user interaction if autoplay is blocked.
      window.addEventListener("click", startAudio, { once: true });
    </script>
  </body>
</html>
